---
title: "Infrastructure feedbacks"
author: "M Fisher"
date: "2023-01-03"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

# Description 

This RMarkdown simulates a HAB in QNMs where there is an additional negative link (`--*`) between **shoreside infrastructure & support services** and **Fuel & labor costs**, completing a negative feedback loop.

In the Status Quo model, a reduction in harvest from a HAB means that less funds go to fishing-specific shoreside infrastructure & support services. If this leads to a decline in infrastructure and services available, variable costs associated with fishing may also go up. 

Unless otherwise noted, all simulations are run until 10,000 stable community matrices are retained.

QNM results shown in the main text: 
    a. Status Quo
    b. Disaster Relief 1 - Direct Assistance
    c. Disaster Relief 2 - Multi-Objective Relief
    d. Supplementary Diversification
    
And then reported in the supplement:
    e. Parametric Insurance
    f. Existing Fisheries Diversification
    g. New Fisheries Diversification
    
    
    
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)

#---- libraries ----
library(here)
library(tidyverse)
library(ggplot2)
library(magrittr)
#Load XML first--dependency not included in QPress
#To install QPress: 
#   library(remotes)
#   remotes::install_github("SWotherspoon/QPress")
library(XML)
library(tcltk2)
library(gridExtra)
library(cowplot)
library(QPress)
library(igraph)

#---- custom functions ----
source(here('R','parse.constraints.SWotherspoon.R'))
source(here('R','get.score.matrix.R') )
source(here('R','compare.models.impact.table.R'))
```


## Set up

how many stable matrices do you want *QPress* to reach? (Fisher et al. uses 10,000; any number up to 50,000 should still take a max of 1-2 minutes per QNM) This should match scripts 01,02
```{r}
nmat <- 10000
```

Variable key
```{r}
sqkey <- read_csv(here('data','sq_variable_key.csv'), col_names=TRUE)
```

simulations without a complete feedback
```{r}
tmp.list <- readRDS(here('data','HAB_sim_out',paste0('HABhi_x_StatusQuo_AllStrat_',nmat/1000,'k.rds')))
```

## Models
For each strategy, read in the simulations without a complete feedback and the dia model with the feedback completed.

status quo
```{r echo=TRUE}
# ---- simulation without fb ----
sq.sim <- tmp.list[[1]]

# ---- dia model ----
m.sq.costs <- model.dia(here::here('data','dia','feedback','StatusQuo_FeedbackInfra_HABhi.dia'))
m.sq.costs <- enforce.limitation(m.sq.costs)

# edge constraints
m.sq.costs.constrained <- parse.constraints(c("Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity"),m.sq.costs)
```


disaster relief 1 (direct assistance)
```{r echo=TRUE}
# ---- simulation without fb ----
dr1.sim <- tmp.list[[3]]

# ---- dia model with fb----
m.dr1.costs <- model.dia(here::here('data','dia','feedback','DisasterRelief-1_FeedbackInfra_HABhi.dia'))
m.dr1.costs <- enforce.limitation(m.dr1.costs)

# edge constraints
m.dr1.costs.constrained <- parse.constraints(c("Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Total crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security"),m.dr1.costs)
```

disaster relief 2 (multi-objective)
```{r echo=TRUE}
# ---- simulation without fb ----
dr2.sim <- tmp.list[[4]]

# ---- dia model with fb ----
m.dr2.costs <- model.dia(here::here('data','dia','feedback','DisasterRelief-2_FeedbackInfra_HABhi.dia'))
m.dr2.costs <- enforce.limitation(m.dr2.costs)

# edge constraints
m.dr2.costs.constrained <- parse.constraints(c("Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Total crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security"),m.dr2.costs)
```

supplemental diversification
```{r echo=TRUE}
# ---- simulation without fb ----
sdiv.sim <- tmp.list[[7]]

# ---- dia model with fb---- 
m.sdiv.costs <- model.dia(here::here('data','dia','feedback','SupplementaryDiversify_FeedbackInfra_HABhi.dia'))
m.sdiv.costs <- enforce.limitation(m.sdiv.costs)  
# no edge constraints
```

insurance
```{r echo=TRUE}
# ---- simulation without fb ----
insure.sim <- tmp.list[[2]]

# ---- dia model ----
m.insure.costs <- model.dia(here::here('data','dia','feedback','ParametricInsurance_FeedbackInfra_HABhi.dia'))
m.insure.costs <- enforce.limitation(m.insure.costs)

# edge constraints
m.insure.costs.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Winter crab harvest -> Total crab harvest < insurance -> Material wealth & security"),m.insure.costs)
```

fisheries diversification 1 (existing)
```{r echo=TRUE}
# ---- simulation without fb ----
div1.sim <- tmp.list[[5]]

# ---- dia model ----
m.div1.costs <- model.dia(here::here('data','dia','feedback','ExistingFisheriesDiversify_FeedbackInfra_HABhi.dia'))
m.div1.costs <- enforce.limitation(m.div1.costs)  

# edge constraints
m.div1.costs.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Crab abundance -> Spr/Sum crab fishery participation < Winter (primary) crab fishery participation -* Winter non.crab fishery participation"),m.div1.costs)
```

fisheries diversification 2 (new)
```{r echo=TRUE}
# ---- simulation without fb ----
div2.sim <- tmp.list[[6]]
rm(tmp.list)

# ---- dia model ----
m.div2.costs <- model.dia(here::here('data','dia','feedback','NewFisheries_FeedbackInfra_HABhi.dia'))
m.div2.costs <- enforce.limitation(m.div2.costs)  

# edge constraints
m.div2.costs.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Crab abundance -> Spr/Sum crab fishery participation < Winter (primary) crab fishery participation -* Winter non.crab fishery participation"),m.div2.costs)
```

<br>

```{r echo=FALSE}
rm(tmp.list)
```

## Simulate HAB with feedback

Status Quo with feedback
```{r}
sq.costs.sampler <- community.ordering.sampler(m.sq.costs.constrained)
sq.costs.sim <- system.simulate(n.sims=nmat, # number of randomly generated matrices to keep
                            edges=m.sq.costs, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=sq.costs.sampler,
                            validators=list(press.validate(
                              m.sq.costs,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)
```

Disaster Relief 1 & 2
```{r}
#---- Disaster Relief 1 with feedback ---- 
dr1.costs.sampler <- community.ordering.sampler(m.dr1.costs.constrained)
dr1.costs.sim <- system.simulate(n.sims=nmat, # number of randomly generated matrices to keep
                            edges=m.dr1.costs, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=dr1.costs.sampler,
                            validators=list(press.validate(
                              m.dr1.costs,     # the qnm
                              perturb = c(`HAB`=1,
                                          `disaster relief (direct)`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- Disaster Relief 2 with feedback ---- 
dr2.costs.sampler <- community.ordering.sampler(m.dr2.costs.constrained)
dr2.costs.sim <- system.simulate(n.sims=nmat, # number of randomly generated matrices to keep
                            edges=m.dr2.costs, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=dr2.costs.sampler,
                            validators=list(press.validate(
                              m.dr2.costs,     # the qnm
                              perturb = c(`HAB`=1,
                                          `disaster relief (direct)`=1,
                                          `disaster relief (invest)`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)
```

Supplementary Diversification with feedback
```{r}
sdiv.costs.sim <- system.simulate(n.sims=nmat, # number of randomly generated matrices to keep
                            edges=m.sdiv.costs, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.costs, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.costs,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

```

Parametric Insurance with feedback
```{r}
insure.costs.sampler <- community.ordering.sampler(m.insure.costs.constrained)
insure.costs.sim <- system.simulate(n.sims=nmat, # number of randomly generated matrices to keep
                            edges=m.insure.costs, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=insure.costs.sampler,
                            validators=list(press.validate(
                              m.insure.costs,     # the qnm
                              perturb = c(`HAB`=1,
                                          `insurance`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)
```

Fisheries Diversification 1 & 2
```{r}
#---- Fish Diversify 1 - Existing Fisheries with feedback ----
div1.costs.sampler <- community.ordering.sampler(m.div1.costs.constrained)
div1.costs.sim <- system.simulate(n.sims=nmat, # number of randomly generated matrices to keep
                            edges=m.div1.costs, # the qnm
                            required.groups=c(0), # this model contains uncertain edges (group 4)
                            sampler=div1.costs.sampler, # the fx to generate the matrices, created above
                            validators=list(press.validate(
                              m.div1.costs,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation plus strategy node
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

#---- Fish Diversify 2 - New Fisheries with feedback ----
div2.costs.sampler <- community.ordering.sampler(m.div2.costs.constrained)
div2.costs.sim <- system.simulate(n.sims=nmat, # number of randomly generated matrices to keep
                            edges=m.div2.costs, # the qnm
                            required.groups=c(0), # this model contains uncertain edges (group 4)
                            sampler=div2.costs.sampler, # the fx to generate the matrices, created above
                            validators=list(press.validate(
                              m.div2.costs,     # the qnm
                              perturb = c(`HAB`=1,`New fishery`=1), # the perturbation plus strategy node
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)
```



Save the simulation output into a list object.
```{r echo=TRUE}
feedback_infra_list <- list(
  sq.costs.sim, insure.costs.sim, 
  dr1.costs.sim, dr2.costs.sim,
  div1.costs.sim, div2.costs.sim,
  sdiv.costs.sim
)

names(feedback_infra_list) <- c("Status_Quo","Insurance","Disaster_Relief_1","Disaster_Relief_2",
                                "Fisheries_Diversify_1","Fisheries_Diversify_2","Supplementary_Diversify")
  
saveRDS(feedback_infra_list, here('data','HAB_sim_out',paste0('Feedback_Infrastructure_x_HABhi_',nmat/1000,'k.rds')))
```


## figure


semi-qualitative categories, and color palette
```{r}
score.df <- data.frame(response=c("Negative-Strong","Negative-Weak","Equivocal","Positive-Strong","Positive-Weak","None"),response.num=c(-2,-1,0,2,1,NA))

table.palette.orange <- c("#04BC09", "#ABF1AD","grey85", "#dfc27d","#a6611a","black")
```


Sub-select variables to include in figures
```{r}
fig4_vars <- sqkey %>% 
# add a hab variable to the sqkey
  bind_rows(data.frame(variable="HAB",group="ecosystem")) %>%
  filter(group %in% c("well-being","well-being 2","well-being 3","capacity")) %>%
  filter(!(variable %in% c("Physical health","Physical safety","Entry of next generation","Equity in resource access")))
```


for supplement: all variables, all strategies (focus strat listed first)
```{r}
compare2.list <- list(sq.sim, sq.costs.sim,
                      dr1.sim,dr1.costs.sim,dr2.sim,dr2.costs.sim,
                      insure.sim,insure.costs.sim,div1.sim, div1.costs.sim, div2.sim,div2.costs.sim,sdiv.sim,sdiv.costs.sim); 
names(compare2.list) <- c("Status Quo","(with Feedback)",
                          "Direct Assistance Disaster Relief","(with Feedback) ","Multi-Objective Disaster Relief","(with Feedback)  ",
                          "Insurance","(with Feedback)   ","Existing Fisheries Diversification","(with Feedback)    ","New Fisheries Diversification","(with Feedback)     ","Supplementary Diversification","(with Feedback)      ")

compare2.all <- compare.models.impact.tbl(sim.list=compare2.list,
                                         perturb.list=list(c(`HAB`=1),c(`HAB`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1,`insurance`=1),c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1),c(`HAB`=1),
                                                           c(`HAB`=1,`New fishery`=1),c(`HAB`=1,`New fishery`=1),
                                         c(`HAB`=1),c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = fig4_vars, variable.order="specific_order",plot=TRUE,
                                    table.palette = table.palette.orange, plot.perturbed=FALSE, main.axis = "Y")
```




```{r}
png(here('doc','drafts','supplement','FigS9-feedbacks-extended.png'), res=200,height=1200,width=1400)
compare2.all[[3]] + geom_hline(aes(yintercept=2.5),linewidth=1) +
  geom_hline(aes(yintercept=4.5),linewidth=1) +
  geom_hline(aes(yintercept=6.5),linewidth=1) +
  geom_hline(aes(yintercept=8.5),linewidth=1) +
  geom_hline(aes(yintercept=10.5),linewidth=1) +
  geom_hline(aes(yintercept=12.5),linewidth=1)
dev.off()
```




just check out the feedback QNMs:
```{r}
compare2.list <- list(sq.costs.sim,
                      dr1.costs.sim,dr2.costs.sim,
                      insure.costs.sim,div1.costs.sim, div2.costs.sim,sdiv.costs.sim); 
names(compare2.list) <- c("Status Quo (with Feedback)",
                          "Direct Assistance Disaster Relief (with Feedback)","Multi-Objective Disaster Relief (with Feedback)",
                          "Insurance (with Feedback)","Existing Fisheries Diversification (with Feedback)","New Fisheries Diversification (with Feedback)","Supplementary Diversification (with Feedback)")

compare2.all <- compare.models.impact.tbl(sim.list=compare2.list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1,`New fishery`=1),
                                         c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = fig4_vars, variable.order="specific_order",plot=TRUE,
                                    table.palette = table.palette.orange, plot.perturbed=FALSE, main.axis = "Y")

compare2.all[[3]]
```



