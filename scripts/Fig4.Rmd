---
title: "Figure 4"
author: "Mary Fisher"
date: "2024-08-09"
output: html_document
---

**Figure 4.** Demonstration of how model structure, through a feedback loop between *Shoreside infrastructure & support services* and variable operating costs (*Fuel & labor costs*), can alter the well-being outcomes associated with select HAB response strategies

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)

#---- libraries ----
library(here)
library(tidyverse)
library(ggplot2)
#Load XML first--dependency not included in QPress
#To install QPress: 
#   library(remotes)
#   remotes::install_github("SWotherspoon/QPress")
library(XML)
library(tcltk2)
library(gridExtra)
library(cowplot)
library(QPress)
library(igraph)
library(magrittr)

#---- custom functions ----
source(here('R','compare.models.impact.dataframe.R'))
source(here('R','compare.baseline.impact.dataframe.R'))
source(here('R','get.score.matrix.R') )
```



## Data

Simulations required: 

1. All of the simulations from set 1 (without feedback)
```{r echo=TRUE}
# ---- status quo ----
tmp.list <- readRDS(here('data','HAB_sim_out','StatusQuo_x_HABhi_50k.rds'))
sq.HABhi.sim <- tmp.list[[1]]

# ---- insurance ----
tmp.list<- readRDS(here('data','HAB_sim_out','Insurance_x_HABhi_50k.rds'))
insure.HABhi.sim <- tmp.list[[1]]

# ---- disaster relief 1 (direct assistance) ----
tmp.list <- readRDS(here('data','HAB_sim_out','DisasterRelief1_x_HABhi_50k.rds'))
dr1.HABhi.sim <- tmp.list[[1]]


# ---- disaster relief 2 (multi-objective) ----
tmp.list <- readRDS(here('data','HAB_sim_out','DisasterRelief2_x_HABhi_50k.rds'))
dr2.HABhi.sim <- tmp.list[[1]]

# ---- fisheries diversification 1 (existing) ----
tmp.list <- readRDS(here('data','HAB_sim_out','ExistingFishDiv1_x_HABhi_50k.rds'))
fdiv1.HABhi.sim <- tmp.list[[1]]


# ---- fisheries diversification 2 (new) ----
tmp.list <- readRDS(here('data','HAB_sim_out','NewFishDiv2_x_HABhi_50k.rds'))
fdiv2.HABhi.sim <- tmp.list[[1]]


# ---- supplemental diversification ----
tmp.list <- readRDS(here('data','HAB_sim_out','SupplementaryDiv_x_HABhi_50k.rds'))
sdiv.HABhi.sim <- tmp.list[[1]]

rm(tmp.list)
```

2. All of the simulations with the feedback

```{r echo=TRUE}
feedback_infra_list <- readRDS(here('data','HAB_sim_out','Feedback_Infrastructure_x_HABhi_50k.rds'))
names(feedback_infra_list)

sq.costs.HABhi.sim <- feedback_infra_list[[1]]
insure.costs.HABhi.sim  <- feedback_infra_list[[2]]
dr1.costs.HABhi.sim <- feedback_infra_list[[3]]
dr2.costs.HABhi.sim <- feedback_infra_list[[4]]
div1.costs.HABhi.sim <- feedback_infra_list[[5]]
div2.costs.HABhi.sim <- feedback_infra_list[[6]]
sdiv.costs.HABhi.sim <- feedback_infra_list[[7]]
```
```{r}
rm(feedback_infra_list)
```


<br>

### Prep to graph

Read in a variable key. This tells the `impact.table` function which variables to report results for, and in what order. There is a separate key for the supplementary diversification adaptation. 
```{r}
sqkey <- read_csv(here('data','sq_variable_key.csv'), col_names=TRUE)
```


semi-qualitative categories, and color palette
```{r}
score.df <- data.frame(response=c("Negative-Strong","Negative-Weak","Equivocal","Positive-Strong","Positive-Weak","None"),response.num=c(-2,-1,0,2,1,NA))

table.palette.orange <- c("#04BC09", "#ABF1AD","grey85", "#dfc27d","#a6611a","black")
```


Sub-select variables to include in figures
```{r}
fig4_vars <- sqkey %>% 
# add a hab variable to the sqkey
  bind_rows(data.frame(variable="HAB",group="ecosystem")) %>%
  filter(group %in% c("well-being","well-being 2","well-being 3","capacity")) %>%
  filter(!(variable %in% c("Physical health","Physical safety","Entry of next generation","Equity in resource access")))
```



## Fig 4a

First, plot in pairs 
```{r height=10,width=7}
# ---- prep: longest y axis label?
nx <- max(nchar("Direct Assistance Disaster Relief"),nchar("Multi-Objective Disaster Relief"),nchar("Supplementary Diversification")) - nchar("(with Feedback)")
nx


# ---- status quo ----
compare.list <- list(sq.HABhi.sim,sq.costs.HABhi.sim); names(compare.list) <- c("Status Quo","                  (with Feedback)")

plot.pairs1 <- compare.models.impact.df(sim.list=compare.list,
                                         perturb.list=list(c(`HAB`=1),c(`HAB`=1)),
                                         monitor.list=list(NA,NA),
                         strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                         plot=TRUE,plot.perturbed=FALSE,main.axis="Y",
                         common.variables=FALSE,variable.key=fig4_vars,variable.order="specific_order",
                         table.palette = table.palette.orange)

# ---- disaster relief 1 ----
compare.list <- list(dr1.HABhi.sim,dr1.costs.HABhi.sim); names(compare.list) <- c("Direct Assistance Disaster Relief","                  (with Feedback)")

plot.pairs2 <- compare.models.impact.df(sim.list=compare.list,
                                         perturb.list=list(c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1)),
                                         monitor.list=list(NA,NA),
                         strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                         plot=TRUE,plot.perturbed=FALSE,main.axis="Y",
                         common.variables=FALSE,variable.key=fig4_vars,variable.order="specific_order",
                         table.palette = table.palette.orange)

# ---- disaster relief 2 ----
compare.list <- list(dr2.HABhi.sim,dr2.costs.HABhi.sim); names(compare.list) <- c("Multi-Objective Disaster Relief","                  (with Feedback)")

plot.pairs3 <- compare.models.impact.df(sim.list=compare.list,
                                         perturb.list=list(c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1)),
                                         monitor.list=list(NA,NA),
                         strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                         plot=TRUE,plot.perturbed=FALSE,main.axis="Y",
                         common.variables=FALSE,variable.key=fig4_vars,variable.order="specific_order",
                         table.palette = table.palette.orange)

# ---- supplementary diversification ----
compare.list <- list(sdiv.HABhi.sim,sdiv.costs.HABhi.sim); names(compare.list) <- c("Supplementary Diversification","                  (with Feedback)")

plot.pairs4 <- compare.models.impact.df(sim.list=compare.list,
                                         perturb.list=list(c(`HAB`=1),c(`HAB`=1)),
                                         monitor.list=list(NA,NA),
                         strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                         plot=TRUE,plot.perturbed=FALSE,main.axis="Y",
                         common.variables=FALSE,variable.key=fig4_vars,variable.order="specific_order",
                         table.palette = table.palette.orange)

```



Then, compare output from feedback QNMs to the baseline
```{r}
compare2.list <- list(sq.costs.HABhi.sim,
                     dr1.costs.HABhi.sim,
                     dr2.costs.HABhi.sim,
                     sdiv.costs.HABhi.sim)
names(compare2.list) <- c("Status Quo","Direct Assistance Disaster Relief","Multi-Objective Disaster Relief","Supplementary Diversification")

plot.baseline <- compare.baseline.impact.df(sim.list=compare2.list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA),
                         strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                         plot=TRUE,
                         common.variables=FALSE,variable.key=fig4_vars,
                         variable.order="specific_order", main.axis="Y",
                         table.palette = table.palette.orange)

plot.baseline[[3]] + labs(subtitle="with Feedback") + 
  guides(fill = guide_legend(order = 1),shape = guide_legend(order = 0))
```


Remove axis labels and legends
```{r}
plot.pairs1a <- plot.pairs1[[3]] + 
  geom_vline(aes(xintercept=10.5), linewidth=0.5) +
  geom_vline(aes(xintercept=13.5), linewidth=0.5) +
  theme(legend.position="none",
        plot.margin=margin(unit(c(5.5, 100.5, 0, 5.5), "points")))

plot.pairs2a <- plot.pairs2[[3]] +
  geom_vline(aes(xintercept=10.5), linewidth=0.5) +
  geom_vline(aes(xintercept=13.5), linewidth=0.5) +
  theme(legend.position="none",axis.text.x=element_blank(),
        plot.margin=margin(unit(c(0, 100.5, 0, 5.5), "points")))

plot.pairs3a <- plot.pairs3[[3]] +
  geom_vline(aes(xintercept=10.5), linewidth=0.5) +
  geom_vline(aes(xintercept=13.5), linewidth=0.5) +
  theme(legend.position="none",axis.text.x=element_blank(),
        plot.margin=margin(unit(c(0, 100.5, 0, 5.5), "points")))

plot.pairs4a <- plot.pairs4[[3]] +
  geom_vline(aes(xintercept=10.5), linewidth=0.5) +
  geom_vline(aes(xintercept=13.5), linewidth=0.5) +
  theme(legend.position="none",axis.text.x=element_blank(),
        plot.margin=margin(unit(c(0, 100.5, 0, 5.5), "points")))
```

All in one plot area
```{r}
plot_grid(plot.pairs1a, plot.pairs2a, plot.pairs3a, plot.pairs4a, ncol=1, nrow=4, rel_heights=c(1,0.4,0.4,0.4))
```




