---
title: "Winter Fishing Opportunity x Strategies"
author: "M Fisher"
date: "run 2023-07-27"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

# Description 

This RMarkdown simulates a high intensity **Harmful Algal Bloom (HAB)** with and without 8 climate adaptation strategies: 

1. Status Quo (no climate adaptation)

2. Fisheries insurance

2. Direct Assistance Disaster Relief (1)

3. Multi-objective Disaster Relief (2)

4. Existing Fisheries Diversification

5. New Fisheries Diversification

6. Supplementary Livelihoods Diversification

7. Imposed New Livelihoods with Fishery Exit

8. Invested New Livelihoods with Fishery Exit


We assume that the HAB has the following impacts in the QNMS:



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)

#---- libraries ----
library(here)
library(tidyverse)
library(ggplot2)
#Load XML first--dependency not included in QPress
#To install QPress: 
#   library(remotes)
#   remotes::install_github("SWotherspoon/QPress")
library(XML)
library(tcltk2)
library(gridExtra)
library(cowplot)
library(QPress)
library(igraph)

#---- custom functions ----
source(here('R','parse.constraints.SWotherspoon.R'))
source(here('R','impact.table.R'))
source(here('R','compare.models.impact.table.R'))
source(here('R','compare.baseline.impact.table.R'))
source(here('R','qnm_sensitivity.R'))
source(here('R','impact.dataframe.R'))
source(here('R','compare.models.impact.dataframe.R'))

get.score.matrix <- function(x){
  x <- x %>% mutate(model2=ifelse(grepl("---",model),"m1","m0")) %>%
    dplyr::select(variable,model2,response.num) %>% 
    pivot_wider(names_from=model2,values_from=response.num) %>%
    mutate(score=abs(m0-m1)) %>%
    mutate(score=ifelse((m0<0)| (m0==0 & m1<0), score*-1,score))
}


```


```{r}
#---- variable key ---- 
## Read in a variable key. This tells the `impact.table` function which variables to report results for, and in what order. 
myvars.cft <- read_csv(here('omf-paper-1','data','cft_variable_key.csv'), col_names=TRUE)

# add a hab variable to the key
myvars.cft <- myvars.cft %>%
  bind_rows(data.frame(variable="HAB",group="ecosystem"))

myvars.suppdiv.cft <- read_csv(here('omf-paper-1','data','cft-test-suppdiv_variable_key.csv'), col_names=TRUE) %>%
  bind_rows(data.frame(variable="HAB",group="ecosystem"))


# save a subset of the variables in a new data frame -- only well-being and capacity variables
subvars.cft <- myvars.cft %>% filter(group %in% c("well-being","well-being 2","well-being 3","capacity")) %>%
  arrange(2)

# for graphs
table.palette=c("#04BC09", "#ABF1AD","#BBBBBB", "#B0BED8","#587AB6","black")
```



## Status Quo

```{r eval=FALSE}
#---- Towns QNM with HAB ---- 
# dia model
m.cft.habhi <- model.dia(here::here('data','dia_models','wc_crab_t2-coastal-towns_seasonal-winter-uncertain_HABhi.dia'))
m.cft.habhi <- enforce.limitation(m.cft.habhi)

# edge constraints
m.cft.habhi.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity"),m.cft.habhi)
cft.habhi.sampler <- community.ordering.sampler(m.cft.habhi.constrained)

```

```{r}

#---- Simulate a HAB ---- 
################# HAB x status quo
cft.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.cft.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=cft.habhi.sampler,
                            validators=list(press.validate(
                              m.cft.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


out <- list(cft.HABhi.sim,cft.cf.HABhi.sim,cft.none.HABhi.sim, cft.one.HABhi.sim)
names(out) <- c("Uncertain Dampening","Crab Facilitates","No Effect","Certain Dampening")
saveRDS(out,here('omf-paper-1','data','HAB_sim_out','townsQNM_StatusQuo_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))
```


## Insurance
```{r insur.sim, eval=FALSE}

## LAST RUN 7/24/2023 to simplify interactions with insurance / crab harvest and emotional & mental health


#----- Default Implementation ----
# dia model
m.insure.habhi <- model.dia(here::here('data','dia_models','strategies','wc_crab_t2-coastal-towns_seasonal_insurance-jobsat-newDefault_HABhi.dia'))
m.insure.habhi <- enforce.limitation(m.insure.habhi)

# edge constraints
m.insure.habhi.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Winter crab harvest -> Total crab harvest < insurance -> Material wealth & security"),m.insure.habhi)
insure.habhi.sampler <- community.ordering.sampler(m.insure.habhi.constrained)

#---- Simulate a HAB ---- 
insure.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.insure.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=insure.habhi.sampler,
                            validators=list(press.validate(
                              m.insure.habhi,     # the qnm
                              perturb = c(`HAB`=1,
                                          `insurance`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)
```


## Disaster Relief 1

```{r dr1.sim, eval=FALSE}

## LAST RUN 7/24/2023 to simplify interactions with insurance / crab harvest and emotional & mental health

#---- Model with HAB ---- 
# dia model
m.dr1.habhi <- model.dia(here::here('data','dia_models','strategies','wc_crab_t2-coastal-towns_seasonal-disaster-1_HABhi.dia'))
m.dr1.habhi <- enforce.limitation(m.dr1.habhi)

# edge constraints
m.dr1.habhi.constrained <- parse.constraints(c("Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Total crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security"),m.dr1.habhi)
dr1.habhi.sampler <- community.ordering.sampler(m.dr1.habhi.constrained)

##### Simulate a HAB
dr1.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.dr1.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=dr1.habhi.sampler,
                            validators=list(press.validate(
                              m.dr1.habhi,     # the qnm
                              perturb = c(`HAB`=1,
                                          `disaster relief (direct)`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

out <- list(dr1.HABhi.sim,dr1.cf.HABhi.sim,dr1.none.HABhi.sim, dr1.one.HABhi.sim)
names(out) <- c("Uncertain Dampening","Crab Facilitates","No Effect","Certain Dampening")
saveRDS(out,here('omf-paper-1','data','HAB_sim_out','townsQNM_DisasterRelief1_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))
```


## Disaster Relief 2

```{r dr2.sim, eval=FALSE}

## LAST RUN 7/24/2023 to simplify interactions with insurance / crab harvest and emotional & mental health

#---- Model with HAB ---- 
# dia model
m.dr2.habhi <- model.dia(here::here('data','dia_models','strategies','wc_crab_t2-coastal-towns_seasonal-disaster-2_HABhi.dia'))
m.dr2.habhi <- enforce.limitation(m.dr2.habhi)

# edge constraints
m.dr2.habhi.constrained <- parse.constraints(c("Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Total crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security"),m.dr2.habhi)
dr2.habhi.sampler <- community.ordering.sampler(m.dr2.habhi.constrained)

#### Simulate a HAB 
dr2.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.dr2.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=dr2.habhi.sampler,
                            validators=list(press.validate(
                              m.dr2.habhi,     # the qnm
                              perturb = c(`HAB`=1,
                                          `disaster relief (direct)`=1,
                                          `disaster relief (invest)`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)



out <- list(dr2.HABhi.sim,dr2.cf.HABhi.sim,dr2.none.HABhi.sim, dr2.one.HABhi.sim)
names(out) <- c("Uncertain Dampening","Crab Facilitates","No Effect","Certain Dampening")
saveRDS(out,here('omf-paper-1','data','HAB_sim_out','townsQNM_DisasterRelief2_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))
```


## Supplementary Livelihoods

This strategy has a slightly different approach to variability in winter fishing opportunities.

The default implementation is structured so that winter crab fishing has (1) an uncertain dampening effect on winter non-crab fishing, and (2) a dampening effect on non-fishing employment. Non-fishing employment and winter non-crab fishing have a two-way dampening effect.

### Without Stress
```{r eval=FALSE}
# dia model
m.sdiv.habhi <- model.dia(here::here('data','dia_models','strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div_HABhi.dia'))
m.sdiv.habhi <- enforce.limitation(m.sdiv.habhi)  

# no edge constraints

################# HAB
sdiv.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

```

The 2nd alternative allows spillover from winter crab fishing to go into non-fishing activity and non-crab fishing, with no trade-off between those two alternatives (a community can "have it all" in terms of non-crab income sources).
```{r eval=FALSE}

# dia model
m.sdiv.noTO.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-no-tradeoff_HABhi.dia'))
m.sdiv.noTO.habhi <- enforce.limitation(m.sdiv.noTO.habhi)  

# no edge constraints

################# HAB x insurance
sdiv.noTO.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.noTO.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.noTO.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.noTO.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

```

The 2nd-4th alternatives are similar to above -- what if winter crab fishing has a certain dampening, facilitating, or no effect on winter non-crab fishing? All of these have the two-way dampening between winter non-crab and non-fishing in place. 
```{r eval=FALSE}
#---- crab dampens ---
# dia model
m.sdiv.one.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-dampens_HABhi.dia'))
m.sdiv.one.habhi <- enforce.limitation(m.sdiv.one.habhi)  

# no edge constraints

################# HAB
sdiv.one.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.one.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.one.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.one.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- crab facilitates ---
# dia model
m.sdiv.cf.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-facilitates_HABhi.dia'))
m.sdiv.cf.habhi <- enforce.limitation(m.sdiv.cf.habhi)  

# no edge constraints

################# HAB
sdiv.cf.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.cf.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.cf.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.cf.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- crab has no effect ---
# dia model
m.sdiv.none.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-noEffect_HABhi.dia'))
m.sdiv.none.habhi <- enforce.limitation(m.sdiv.none.habhi)  

# no edge constraints

################# HAB
sdiv.none.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.none.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.none.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.none.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


out <- list(sdiv.HABhi.sim,sdiv.noTO.HABhi.sim,sdiv.cf.HABhi.sim,sdiv.none.HABhi.sim, sdiv.one.HABhi.sim)
names(out) <- c("Uncertain Dampening","Uncertain Dampening no TO","Crab Facilitates","No Effect","Certain Dampening")
saveRDS(out,here('omf-paper-1','data','HAB_sim_out','townsQNM_SuppDiversification_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))
```
```{r}
sqlist <- readRDS(here('omf-paper-1','data','HAB_sim_out','townsQNM_SuppDiversification_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))

sdiv.HABhi.sim <- sqlist[[1]]
sdiv.noTO.HABhi.sim <- sqlist[[2]]
sdiv.cf.HABhi.sim <- sqlist[[3]]
sdiv.none.HABhi.sim <- sqlist[[4]]
sdiv.one.HABhi.sim <- sqlist[[5]]
```

```{r fig.height=6, fig.width=6}
sdiv_list <- list(sdiv.HABhi.sim,sdiv.noTO.HABhi.sim,  sdiv.one.HABhi.sim, sdiv.cf.HABhi.sim, sdiv.none.HABhi.sim); names(sdiv_list) <- c("Default Supp Diverse","Supp Diverse no Trade-off","Crab Dampens","Crab Facilitates","Crab has No Effect")
compare.sdiv.sub <- compare.models.impact.df(sim.list=sdiv_list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars.cft, variable.order="specific_order",plot=TRUE)
compare.sdiv.sub[[3]]
```


The 5th & 6th alternatives are a sidebar -- does it matter if we allow a two-way dampening relationship between winter crab and non-crab fishing? Instead of a one-way relationships where winter crab fishing dampens winter non-crab fishing. I want to evaluate this with and without the trade-off between non-crab fishing and non-fishing employment in place. 
```{r}
#---- crab dampens, no trade-off ---
# dia model
m.sdiv.oneNoTO.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-dampens-noTO_HABhi.dia'))
m.sdiv.oneNoTO.habhi <- enforce.limitation(m.sdiv.oneNoTO.habhi)  

# no edge constraints

###### HAB
sdiv.oneNoTO.HABhi.sim <- system.simulate(n.sims=10000, # number of randomly generated matrices to keep
                            edges=m.sdiv.oneNoTO.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.oneNoTO.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.oneNoTO.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

#---- 2 way crab-non.crab dampening, no trade-off ---
# dia model
m.sdiv.one2way.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-with-fishdiv2_HABhi.dia'))
m.sdiv.one2way.habhi <- enforce.limitation(m.sdiv.one2way.habhi)  

# no edge constraints

######## HAB
sdiv.one2way.HABhi.sim <- system.simulate(n.sims=10000, # number of randomly generated matrices to keep
                            edges=m.sdiv.one2way.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.one2way.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.one2way.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

#---- 2 way crab-non.crab dampening, no trade-off ---
# dia model
m.sdiv.one2wayNoTO.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-with-fishdiv2-noTO_HABhi.dia'))
m.sdiv.one2wayNoTO.habhi <- enforce.limitation(m.sdiv.one2wayNoTO.habhi)  

# no edge constraints

######## HAB
sdiv.one2wayNoTO.HABhi.sim <- system.simulate(n.sims=10000, # number of randomly generated matrices to keep
                            edges=m.sdiv.one2wayNoTO.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.one2wayNoTO.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.one2wayNoTO.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

```

```{r  fig.height=6, fig.width=5}
sidebar <- list(sdiv.one.HABhi.sim, sdiv.oneNoTO.HABhi.sim, sdiv.one2way.HABhi.sim, sdiv.one2wayNoTO.HABhi.sim); names(sidebar) <- c("Crab Dampens","Crab Dampens no TO","2-way Dampen","2-way Dampen, no TO")
compare.sidebar.sub <- compare.models.impact.df(sim.list=sidebar,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars.cft, variable.order="specific_order",plot=TRUE)
compare.sidebar.sub[[3]]
```



```{r eval=FALSE}
# to print
sidebar <- list(sdiv.one.HABhi.sim, sdiv.oneNoTO.HABhi.sim, sdiv.one2way.HABhi.sim, sdiv.one2wayNoTO.HABhi.sim); names(sidebar) <- c("Crab Dampens","Crab Dampens no TO","2-way Dampen","2-way Dampen, no TO")
compare.sidebar <- compare.models.impact.df(sim.list=sidebar,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = myvars.suppdiv.cft, variable.order="specific_order",plot=TRUE)
png(here('omf-paper-1/data/HAB_sim_out/townsQNM_HAB-Strategies','HABhi_supplement-div_two-way-fishing-tradeoff_table.png'), width=500, height=800)
compare.sidebar[[3]]
dev.off()
```

### With Stress
```{r eval=FALSE}
# --- default ---
# dia model
m.sdivS.habhi <- model.dia(here::here('data','dia_models','strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-stress_HABhi.dia'))
m.sdivS.habhi <- enforce.limitation(m.sdivS.habhi)  

# no edge constraints

################# HAB x insurance
sdivS.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdivS.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdivS.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdivS.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


out <- list(sdivS.HABhi.sim, sdivS.one.HABhi.sim,sdivS.cf.HABhi.sim,sdivS.none.HABhi.sim)
names(out) <- c("Stress, Uncertain Dampening","Stress, Certain Dampening","Stress, Crab Facilitates","Stress, No Effect")
saveRDS(out,here('omf-paper-1','data','HAB_sim_out','townsQNM_SuppDiversificationStress_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))
```

```{r fig.height=6, fig.width=6}
sdiv_list <- list(sdivS.HABhi.sim,sdivS.one.HABhi.sim, sdivS.cf.HABhi.sim, sdivS.none.HABhi.sim); names(sdiv_list) <- c("Default Supp Diverse","Crab Dampens","Crab Facilitates","Crab has No Effect")
compare.sdiv.sub <- compare.models.impact.df(sim.list=sdiv_list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars.cft, variable.order="specific_order",plot=TRUE)
compare.sdiv.sub[[3]]
```




## Explore output

Read in a variable key. 
```{r}
sqkey <- read_csv(here('data','sq_variable_key.csv'), col_names=TRUE)

# add a hab variable to the key
sqkey <- sqkey %>%
  bind_rows(data.frame(variable="HAB",group="ecosystem"))

# save a subset of the variables in a new data frame -- only well-being and capacity variables
subvars <- sqkey %>% filter(group %in% c("well-being","well-being 2","well-being 3","capacity")) %>%
  arrange(2)
```




```{r  fig.height=6, fig.width=8}
tmp_list <- list(cft.HABhi.sim, cft.one.HABhi.sim, insure.HABhi.sim,insure.one.HABhi.sim,
                 dr1.HABhi.sim,dr1.one.HABhi.sim,
                 dr2.HABhi.sim,dr2.one.HABhi.sim,
                 sdivS.HABhi.sim,sdivS.one.HABhi.sim); names(tmp_list) <- c("Status Quo", " ---Crab Dampens SQ",
                                                                          "Insurance Default"," ---Crab Dampens I",
                                                                          "Disaster Relief 1 Default"," ---Crab Dampens DR1",
                                                                          "Disaster Relief 2 Default"," ---Crab Dampens DR2",
                                                                          "Supp Diverse Default"," ---Crab Dampens SDIV")
compare.alt1.sub <- compare.models.impact.df(sim.list=tmp_list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars.cft, variable.order="specific_order",plot=TRUE)
compare.alt1.sub[[3]] + geom_vline(aes(xintercept=2.5), linewidth=1.5) + 
  geom_vline(aes(xintercept=4.5), linewidth=1.5) + 
  geom_vline(aes(xintercept=6.5), linewidth=1.5) + 
  geom_vline(aes(xintercept=8.5), linewidth=1.5)
```




