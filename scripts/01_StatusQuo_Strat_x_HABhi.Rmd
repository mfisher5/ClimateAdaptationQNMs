---
title: "Simulate a HAB in Status Quo and Strategy QNMs"
author: "M Fisher"
date: "2023-07-27"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

# Description 

This RMarkdown simulates a Harmful Algal Bloom (HAB) with and without 8 climate adaptation strategies: 

1. Status Quo (no climate adaptation)

2. Fisheries insurance

3. Direct Assistance Disaster Relief (1)

4. Multi-objective Disaster Relief (2)

5. Existing Fisheries Diversification

6. New Fisheries Diversification

7. Supplementary Livelihoods Diversification

8. Imposed New Livelihoods with Fishery Exit

9. Invested New Livelihoods with Fishery Exit


We assume that the HAB has the following impacts in QNMs #1-6:

a. Negative influence on *Early season crab fishery participation*

b. Negative influence on *Fuel & labor costs* 

c. Negative influence on *Opening dock price*


We assume that the HAB has the following impacts in QNMs #7-8:

a. Negative influence on *Recreational fishery participation*

The `system.simulate` function in QPRESS shouldn't take more than 10-15s to run, even with 50k stable matrices required. 



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)

#---- libraries ----
library(here)
library(tidyverse)
library(ggplot2)
#Load XML first--dependency not included in QPress
#To install QPress: 
#   library(remotes)
#   remotes::install_github("SWotherspoon/QPress")
library(XML)
library(tcltk2)
library(gridExtra)
library(cowplot)
library(QPress)

#---- custom functions ----
source(here('R','parse.constraints.SWotherspoon.R'))
source(here('R','impact.table.R'))
source(here('R','compare.models.impact.table.R'))
source(here('R','compare.baseline.impact.table.R'))
source(here('R','get.score.matrix.R'))

#---- let's time things! ----
end.timer <- function(s){Sys.time() - s}
```

# Set up 
variable key - this tells the `impact.table` function which variables to report results for, and in what order.
```{r}
sqkey <- read_csv(here('data','sq_variable_key.csv'), col_names=TRUE)
```

sub-select variables to include in figures
```{r}
subvars <- sqkey %>% 
# add a hab variable to the sqkey
  bind_rows(data.frame(variable="HAB",group="ecosystem")) %>%
  filter(group %in% c("well-being","well-being 2","well-being 3","capacity")) %>%
  filter(!(variable %in% c("Physical health","Physical safety","Equity in resource access")))
```

semi-qualitative categories, and color palette
```{r}
score.df <- data.frame(response=c("Negative-Strong","Negative-Weak","Equivocal","Positive-Strong","Positive-Weak","None"),response.num=c(-2,-1,0,2,1,NA))

table.palette.orange <- c("#04BC09", "#ABF1AD","grey85", "#dfc27d","#a6611a","black") # for plotting fx
```

# Run QPress

## Status Quo

```{r}
# dia model
m.sq <- model.dia(here::here('data','dia','StatusQuo_HABhi.dia'))
m.sq <- enforce.limitation(m.sq)

# edge constraints
m.sq.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security"),m.sq)
sq.sampler <- community.ordering.sampler(m.sq.constrained)

```

Simulate a HAB 
```{r sq.sim}
s <- Sys.time()

sq.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sq, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=sq.sampler,
                            validators=list(press.validate(
                              m.sq,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```


## Insurance

note - rerun 7/24/2023 to simplify interactions with insurance / crab harvest and emotional & mental health
```{r}
m.insure <- model.dia(here::here('data','dia','ParametricInsurance_HABhi.dia'))
m.insure <- enforce.limitation(m.insure)

# edge constraints
m.insure.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Winter crab harvest -> Total crab harvest < insurance -> Material wealth & security"),m.insure)
insure.sampler <- community.ordering.sampler(m.insure.constrained)
```

Simulate a HAB 
```{r insur.sim}
s <- Sys.time()

insure.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.insure, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=insure.sampler,
                            validators=list(press.validate(
                              m.insure,     # the qnm
                              perturb = c(`HAB`=1,
                                          `insurance`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```


## Disaster Relief 1

```{r}
# dia model
m.dr1 <- model.dia(here::here('data','dia','DisasterRelief-1-DirectAssist_HABhi.dia'))
m.dr1 <- enforce.limitation(m.dr1)

# edge constraints
m.dr1.constrained <- parse.constraints(c("Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Total crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security"),m.dr1)
dr1.sampler <- community.ordering.sampler(m.dr1.constrained)
```

Simulate a HAB
```{r dr1.sim}
s <- Sys.time()

dr1.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.dr1, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=dr1.sampler,
                            validators=list(press.validate(
                              m.dr1,     # the qnm
                              perturb = c(`HAB`=1,
                                          `disaster relief (direct)`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```


## Disaster Relief 2

```{r}
# dia model
m.dr2 <- model.dia(here::here('data','dia','DisasterRelief-2-MultiObj_HABhi.dia'))
m.dr2 <- enforce.limitation(m.dr2)

# edge constraints
m.dr2.constrained <- parse.constraints(c("Total non.crab harvest -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Non.crab fishing activity -> Identity < Crab fishing activity -> Identity",
                                         "Total crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security",
                                         "Total non.crab harvest -> Material wealth & security < disaster relief (direct) -> Material wealth & security"),m.dr2)
dr2.sampler <- community.ordering.sampler(m.dr2.constrained)
```

Simulate a HAB
```{r dr2.sim}
s <- Sys.time()

dr2.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.dr2, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=dr2.sampler,
                            validators=list(press.validate(
                              m.dr2,     # the qnm
                              perturb = c(`HAB`=1,
                                          `disaster relief (direct)`=1,
                                          `disaster relief (invest)`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```


## Existing Fisheries Diversification

```{r}
# dia model
m.fdiv1 <- model.dia(here::here('data','dia_models','strategies','ExistingFisheriesDiversify_HABhi.dia'))
m.fdiv1 <- enforce.limitation(m.fdiv1)  

# edge constraints
m.fdiv1.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Crab abundance -> Spr/Sum crab fishery participation < Winter (primary) crab fishery participation -* Winter non.crab fishery participation"),m.fdiv1)
fdiv1.sampler <- community.ordering.sampler(m.fdiv1.constrained)
```

Simulate a HAB
```{r fdiv1.sim}
s <- Sys.time()

fdiv1.hab.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.fdiv1, # the qnm
                            required.groups=c(0), # this model contains uncertain edges (group 4)
                            sampler=fdiv1.sampler, # the fx to generate the matrices, created above
                            validators=list(press.validate(
                              m.fdiv1,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation plus strategy node
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```


## New Fisheries Diversification

```{r}
# dia model
m.fdiv2 <- model.dia(here::here('data','dia','NewFisheries_HABhi.dia'))
m.fdiv2 <- enforce.limitation(m.fdiv2)  

# edge constraints
m.fdiv2.constrained <- parse.constraints(c("Total non.fishing income -> Material wealth & security < Total crab harvest -> Material wealth & security",
                                         "Total non.fishing income -> Material wealth & security < Total non.crab harvest -> Material wealth & security",
                                         "Crab abundance -> Spr/Sum crab fishery participation < Winter (primary) crab fishery participation -* Winter non.crab fishery participation"),m.fdiv2)
fdiv2.sampler <- community.ordering.sampler(m.fdiv2.constrained)

```

Simulate a HAB
```{r fdiv2.sim}
s <- Sys.time()

fdiv2.hab.sim <- system.simulate(n.sims=10000, # number of randomly generated matrices to keep
                            edges=m.fdiv2, # the qnm
                            required.groups=c(0), # this model contains uncertain edges (group 4)
                            sampler=fdiv2.sampler, # the fx to generate the matrices, created above
                            validators=list(press.validate(
                              m.fdiv2,     # the qnm
                              perturb = c(`HAB`=1,`New fishery`=1), # the perturbation plus strategy node
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


end.timer(s)
```


## Supplementary Livelihoods

The QNM is structured so that winter crab fishing has a dampening effect on non-fishing employment, in addition to an uncertain dampening effect on winter non-crab fishing, and (2) . Non-fishing employment and winter non-crab fishing have a two-way dampening effect. The idea is to preference winter crab fishing, but to make supplementary non-fishing livelihoods, and alternative fisheries, 'equivalent.'

We also assumed that supplementary livelihoods was associated with some degree of stress (per KM Moore et al. 2019), which has a direct negative influence on *Emotional & mental health* (although, an indirect positive influence, via *Material wealth & security*).


```{r}
# dia model
m.sdivS <- model.dia(here::here('data','dia','SupplementaryDiversify_HABhi.dia'))
m.sdivS <- enforce.limitation(m.sdivS)  

# no edge constraints
```

Simulate a HAB
```{r}
s <- Sys.time()

sdivS.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdivS, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdivS, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdivS,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```


## Imposed New Livelihoods

```{r}
# dia model
m.ldiv1 <- model.dia(here::here('data','dia','LivelihoodDiversify-1-Imposed_HABhi.dia'))
m.ldiv1 <- enforce.limitation(m.ldiv1)  

# no edge constraints
```

Simulate a HAB
```{r}
s <- Sys.time()

ldiv1.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.ldiv1, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.ldiv1, required.groups = c(0)),
                            validators=list(press.validate(
                              m.ldiv1,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```



## Invested New Livelihoods 

- Version 2: 

```{r}
# dia model
m.ldiv2 <- model.dia(here::here('data','dia','LivelihoodDiversify-2-Invested_HABhi.dia'))
m.ldiv2 <- enforce.limitation(m.ldiv2)  

# no edge constraints
```

Simulate a HAB
```{r}
s <- Sys.time()

ldiv2.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.ldiv2, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.ldiv2, required.groups = c(0)),
                            validators=list(press.validate(
                              m.ldiv2,     # the qnm
                              perturb = c(`HAB`=1,`Transition support`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

end.timer(s)
```


## Save output

Into a list, so it can be called up in later scripts (like 2b).
```{r}
out.list <- list(sq.sim,insure.sim,dr1.sim,dr2.sim,fdiv1.sim, fdiv2.sim,sdivS.sim,ldiv1.sim,ldiv2.sim)
saveRDS(here('data','HAB_sim_out','HABhi_x_StatusQuo_AllStrat.rds'))
```


## Explore output

### coping / adaptive 1-6 

Using the `compare.models.impact.table` function, to produce a table of semi-qualitative outputs for each aspect of well-being / strategy.
```{r  fig.height=6, fig.width=8}
tmp_list <- list(sq.sim, insure.sim,
                 dr1.sim,
                 dr2.sim,
                 sdivS.sim); names(tmp_list) <- c("Status Quo","Insurance","Disaster Relief 1", "Disaster Relief 2", "Supp Diverse Default")
compare.sub <- compare.models.impact.tbl(sim.list=tmp_list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars, variable.order="specific_order",plot=TRUE)
```

The first object in the list provides the data frame of results that are presented in the table. The second saves all of the variables' output, not just the ones included in the table. This might be helpful for digging into unexpected results
```{r}
head(table.results.df)
```

The third object in the list is the plot itself. We can make this look nice later, in the figure 2 script.
```{r}
compare.sub[[3]] + geom_vline(aes(xintercept=2.5), linewidth=1.5) + 
  geom_vline(aes(xintercept=4.5), linewidth=1.5) + 
  geom_vline(aes(xintercept=6.5), linewidth=1.5) + 
  geom_vline(aes(xintercept=8.5), linewidth=1.5)
```

### transformative 7-8

```{r}
tmp_list <- list(ldiv.HABhi.sim,ldiv2.HABhi.sim)
names(tmp_list) <- c("Imposed New Livelihoods", "Invested New Livelihoods")
hab.ldiv.out <- compare.models.impact.df(sim.list=tmp_list,
                                          perturb.list=list(c(`HAB`=1),
                                                            c(`HAB`=1,`Transition support`=1)),
                                          monitor.list=list(NA,NA),
                         strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                         plot=TRUE,plot.perturbed=FALSE,
                         common.variables=FALSE,variable.key=subvars,variable.order="specific_order", main.axis="Y",
                         table.palette = table.palette.orange)

hab.ldiv.out[[3]] +
  scale_x_discrete(position = "bottom",expand = c(0.05, 0.05)) +
  theme(legend.position = "none",axis.text.x=element_text(angle=45,hjust=1))
```


