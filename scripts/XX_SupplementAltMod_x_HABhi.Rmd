---
title: "Alt Influential Link - Supplementary Diversification"
author: "M Fisher"
date: "run 2023-07-27"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)

#---- libraries ----
library(here)
library(tidyverse)
library(ggplot2)
#Load XML first--dependency not included in QPress
#To install QPress: 
#   library(remotes)
#   remotes::install_github("SWotherspoon/QPress")
library(XML)
library(tcltk2)
library(gridExtra)
library(cowplot)
library(QPress)
library(igraph)

#---- custom functions ----
source(here('R','parse.constraints.SWotherspoon.R'))
# source(here('R','impact.table.R'))
source(here('R','compare.models.impact.table.R'))
source(here('R','compare.baseline.impact.table.R'))
source(here('R','qnm.sensitivity.R'))
# source(here('R','impact.dataframe.R'))
source(here('R','compare.models.impact.table.R'))

get.score.matrix <- function(x){
  x <- x %>% mutate(model2=ifelse(grepl("---",model),"m1","m0")) %>%
    dplyr::select(variable,model2,response.num) %>% 
    pivot_wider(names_from=model2,values_from=response.num) %>%
    mutate(score=abs(m0-m1)) %>%
    mutate(score=ifelse((m0<0)| (m0==0 & m1<0), score*-1,score))
}


```

## Supplementary Livelihoods

This strategy has a slightly different approach to variability in winter fishing opportunities.

The default implementation is structured so that winter crab fishing has (1) an uncertain dampening effect on winter non-crab fishing, and (2) a dampening effect on non-fishing employment. Non-fishing employment and winter non-crab fishing have a two-way dampening effect.

### Without Stress
```{r eval=FALSE}
# dia model
m.sdiv.habhi <- model.dia(here::here('data','dia_models','strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div_HABhi.dia'))
m.sdiv.habhi <- enforce.limitation(m.sdiv.habhi)  

# no edge constraints

################# HAB
sdiv.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

```

The 2nd alternative allows spillover from winter crab fishing to go into non-fishing activity and non-crab fishing, with no trade-off between those two alternatives (a community can "have it all" in terms of non-crab income sources).
```{r eval=FALSE}

# dia model
m.sdiv.noTO.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-no-tradeoff_HABhi.dia'))
m.sdiv.noTO.habhi <- enforce.limitation(m.sdiv.noTO.habhi)  

# no edge constraints

################# HAB x insurance
sdiv.noTO.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.noTO.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.noTO.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.noTO.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

```

The 2nd-4th alternatives are similar to above -- what if winter crab fishing has a certain dampening, facilitating, or no effect on winter non-crab fishing? All of these have the two-way dampening between winter non-crab and non-fishing in place. 
```{r eval=FALSE}
#---- crab dampens ---
# dia model
m.sdiv.one.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-dampens_HABhi.dia'))
m.sdiv.one.habhi <- enforce.limitation(m.sdiv.one.habhi)  

# no edge constraints

################# HAB
sdiv.one.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.one.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.one.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.one.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- crab facilitates ---
# dia model
m.sdiv.cf.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-facilitates_HABhi.dia'))
m.sdiv.cf.habhi <- enforce.limitation(m.sdiv.cf.habhi)  

# no edge constraints

################# HAB
sdiv.cf.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.cf.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.cf.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.cf.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- crab has no effect ---
# dia model
m.sdiv.none.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-noEffect_HABhi.dia'))
m.sdiv.none.habhi <- enforce.limitation(m.sdiv.none.habhi)  

# no edge constraints

################# HAB
sdiv.none.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdiv.none.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.none.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.none.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


out <- list(sdiv.HABhi.sim,sdiv.noTO.HABhi.sim,sdiv.cf.HABhi.sim,sdiv.none.HABhi.sim, sdiv.one.HABhi.sim)
names(out) <- c("Uncertain Dampening","Uncertain Dampening no TO","Crab Facilitates","No Effect","Certain Dampening")
saveRDS(out,here('omf-paper-1','data','HAB_sim_out','townsQNM_SuppDiversification_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))
```
```{r}
sqlist <- readRDS(here('omf-paper-1','data','HAB_sim_out','townsQNM_SuppDiversification_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))

sdiv.HABhi.sim <- sqlist[[1]]
sdiv.noTO.HABhi.sim <- sqlist[[2]]
sdiv.cf.HABhi.sim <- sqlist[[3]]
sdiv.none.HABhi.sim <- sqlist[[4]]
sdiv.one.HABhi.sim <- sqlist[[5]]
```

```{r fig.height=6, fig.width=6}
sdiv_list <- list(sdiv.HABhi.sim,sdiv.noTO.HABhi.sim,  sdiv.one.HABhi.sim, sdiv.cf.HABhi.sim, sdiv.none.HABhi.sim); names(sdiv_list) <- c("Default Supp Diverse","Supp Diverse no Trade-off","Crab Dampens","Crab Facilitates","Crab has No Effect")
compare.sdiv.sub <- compare.models.impact.df(sim.list=sdiv_list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars.cft, variable.order="specific_order",plot=TRUE)
compare.sdiv.sub[[3]]
```


The 5th & 6th alternatives are a sidebar -- does it matter if we allow a two-way dampening relationship between winter crab and non-crab fishing? Instead of a one-way relationships where winter crab fishing dampens winter non-crab fishing. I want to evaluate this with and without the trade-off between non-crab fishing and non-fishing employment in place. 
```{r}
#---- crab dampens, no trade-off ---
# dia model
m.sdiv.oneNoTO.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-dampens-noTO_HABhi.dia'))
m.sdiv.oneNoTO.habhi <- enforce.limitation(m.sdiv.oneNoTO.habhi)  

# no edge constraints

###### HAB
sdiv.oneNoTO.HABhi.sim <- system.simulate(n.sims=10000, # number of randomly generated matrices to keep
                            edges=m.sdiv.oneNoTO.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.oneNoTO.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.oneNoTO.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

#---- 2 way crab-non.crab dampening, no trade-off ---
# dia model
m.sdiv.one2way.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-with-fishdiv2_HABhi.dia'))
m.sdiv.one2way.habhi <- enforce.limitation(m.sdiv.one2way.habhi)  

# no edge constraints

######## HAB
sdiv.one2way.HABhi.sim <- system.simulate(n.sims=10000, # number of randomly generated matrices to keep
                            edges=m.sdiv.one2way.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.one2way.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.one2way.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

#---- 2 way crab-non.crab dampening, no trade-off ---
# dia model
m.sdiv.one2wayNoTO.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-with-fishdiv2-noTO_HABhi.dia'))
m.sdiv.one2wayNoTO.habhi <- enforce.limitation(m.sdiv.one2wayNoTO.habhi)  

# no edge constraints

######## HAB
sdiv.one2wayNoTO.HABhi.sim <- system.simulate(n.sims=10000, # number of randomly generated matrices to keep
                            edges=m.sdiv.one2wayNoTO.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdiv.one2wayNoTO.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdiv.one2wayNoTO.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)

```

```{r  fig.height=6, fig.width=5}
sidebar <- list(sdiv.one.HABhi.sim, sdiv.oneNoTO.HABhi.sim, sdiv.one2way.HABhi.sim, sdiv.one2wayNoTO.HABhi.sim); names(sidebar) <- c("Crab Dampens","Crab Dampens no TO","2-way Dampen","2-way Dampen, no TO")
compare.sidebar.sub <- compare.models.impact.df(sim.list=sidebar,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars.cft, variable.order="specific_order",plot=TRUE)
compare.sidebar.sub[[3]]
```



```{r eval=FALSE}
# to print
sidebar <- list(sdiv.one.HABhi.sim, sdiv.oneNoTO.HABhi.sim, sdiv.one2way.HABhi.sim, sdiv.one2wayNoTO.HABhi.sim); names(sidebar) <- c("Crab Dampens","Crab Dampens no TO","2-way Dampen","2-way Dampen, no TO")
compare.sidebar <- compare.models.impact.df(sim.list=sidebar,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = myvars.suppdiv.cft, variable.order="specific_order",plot=TRUE)
png(here('omf-paper-1/data/HAB_sim_out/townsQNM_HAB-Strategies','HABhi_supplement-div_two-way-fishing-tradeoff_table.png'), width=500, height=800)
compare.sidebar[[3]]
dev.off()
```

### With Stress
```{r eval=FALSE}
# --- default ---
# dia model
m.sdivS.habhi <- model.dia(here::here('data','dia_models','strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-stress_HABhi.dia'))
m.sdivS.habhi <- enforce.limitation(m.sdivS.habhi)  

# no edge constraints

################# HAB x insurance
sdivS.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdivS.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdivS.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdivS.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- crab dampens ---
# dia model
m.sdivS.one.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-dampens_HABhi.dia'))
m.sdivS.one.habhi <- enforce.limitation(m.sdivS.one.habhi)  

# no edge constraints

################# HAB
sdivS.one.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdivS.one.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdivS.one.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdivS.one.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- crab facilitates ---
# dia model
m.sdivS.cf.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-facilitates_HABhi.dia'))
m.sdivS.cf.habhi <- enforce.limitation(m.sdivS.cf.habhi)  

# no edge constraints

################# HAB
sdivS.cf.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdivS.cf.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdivS.cf.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdivS.cf.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


#---- crab has no effect ---
# dia model
m.sdivS.none.habhi <- model.dia(here::here('omf-paper-1','data','dia_model_strategies','wc_crab_t2-coastal-towns_seasonal-supplement-div-crab-noEffect_HABhi.dia'))
m.sdivS.none.habhi <- enforce.limitation(m.sdivS.none.habhi)  

# no edge constraints

################# HAB
sdivS.none.HABhi.sim <- system.simulate(n.sims=50000, # number of randomly generated matrices to keep
                            edges=m.sdivS.none.habhi, # the qnm
                            required.groups = c(0), # allow uncertain edges
                            sampler=community.sampler(m.sdivS.none.habhi, required.groups = c(0)),
                            validators=list(press.validate(
                              m.sdivS.none.habhi,     # the qnm
                              perturb = c(`HAB`=1), # the perturbation
                              monitor = NA))) # a list of expected outcomes that should happen in the simulation (I don't usually use this)


out <- list(sdivS.HABhi.sim, sdivS.one.HABhi.sim,sdivS.cf.HABhi.sim,sdivS.none.HABhi.sim)
names(out) <- c("Stress, Uncertain Dampening","Stress, Certain Dampening","Stress, Crab Facilitates","Stress, No Effect")
saveRDS(out,here('omf-paper-1','data','HAB_sim_out','townsQNM_SuppDiversificationStress_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))
```
```{r}
sqlist <- readRDS(here('omf-paper-1','data','HAB_sim_out','townsQNM_SuppDiversification_x_HABhi_WinterFishingImp_50kSystemSimulate.rds'))

sdivS.HABhi.sim <- sqlist[[1]]
sdivS.one.HABhi.sim <- sqlist[[2]]
sdivS.cf.HABhi.sim <- sqlist[[3]]
sdivS.none.HABhi.sim <- sqlist[[4]]
```
```{r fig.height=6, fig.width=6}
sdiv_list <- list(sdivS.HABhi.sim,sdivS.one.HABhi.sim, sdivS.cf.HABhi.sim, sdivS.none.HABhi.sim); names(sdiv_list) <- c("Default Supp Diverse","Crab Dampens","Crab Facilitates","Crab has No Effect")
compare.sdiv.sub <- compare.models.impact.df(sim.list=sdiv_list,
                                         perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = subvars.cft, variable.order="specific_order",plot=TRUE)
compare.sdiv.sub[[3]]
```


There are no changes in variable response with the addition of the link: `Non-fishing livelihood activity --* Emotional & mental health`. 

