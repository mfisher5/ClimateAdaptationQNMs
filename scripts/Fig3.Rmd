---
title: 'Figure 3: Model Structure changes'
author: "M Fisher"
date: "2023-07-25"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

**Figure 3.** Demonstration of how changes to model structure, through changing an influential link, can alter well-being outcomes (horizontal axis) from adaptation strategies (vertical axis). The effects of different degrees of in-season fishing flexibility (a-Waiting for crab, b-Crab Has No Effect, c-Switching targets) are summarized for the Status Quo and three non-transformative strategies. Well-being variable responses for adaptation strategies are shown only where they differ from the Status Quo (as in Fig 2; Fig S8 shows full table). Fig S7 diagrams how we altered the influential link in the QNM.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE)

#---- libraries ----
library(here)
library(tidyverse)
library(ggplot2)
#Load XML first--dependency not included in QPress
#To install QPress: 
#   library(remotes)
#   remotes::install_github("SWotherspoon/QPress")
library(XML)
library(tcltk2)
library(gridExtra)
library(cowplot)
library(QPress)
library(magrittr)
# library(igraph)
library(gridExtra)

#---- custom functions ----
source(here('R','compare.models.impact.table.R'))
source(here('R','compare.baseline.impact.table.R'))
source(here('R','get.score.matrix.R') )
```



## Data

Simulations required:
```{r echo=TRUE}
# ---- status quo ----
sqlist <- readRDS(here('data','HAB_sim_out','StatusQuo_x_HABhi_50k.rds'))

sq.sim <- sqlist[[1]]
sq.wait.sim <- sqlist[[2]]
sq.no.sim <- sqlist[[3]]
sq.one.sim <- sqlist[[4]]

# ---- insurance ----
insure.list <- readRDS(here('data','HAB_sim_out','Insurance_x_HABhi_50k.rds'))

insure.sim <- insure.list[[1]]
insure.wait.sim <- insure.list[[2]]
insure.no.sim <- insure.list[[3]]
insure.one.sim <- insure.list[[4]]

# ---- disaster relief 1 ----
dr1list <- readRDS(here('data','HAB_sim_out','DisasterRelief1_x_HABhi_50k.rds')); names(dr1list)

dr1.sim <- dr1list[[1]]
dr1.wait.sim <- dr1list[[2]]
dr1.no.sim <- dr1list[[3]]
dr1.one.sim <- dr1list[[4]]


# ---- disaster relief 2 ----
dr2list <- readRDS(here('data','HAB_sim_out','DisasterRelief2_x_HABhi_50k.rds')); names(dr2list)

dr2.sim <- dr2list[[1]]
dr2.wait.sim <- dr2list[[2]]
dr2.no.sim <- dr2list[[3]]
dr2.one.sim <- dr2list[[4]]


# ---- supplemental diversification ----
sdiv.list <- readRDS(here('data','HAB_sim_out','SupplementaryDiv_x_HABhi_50k.rds')); names(sdiv.list)

sdiv.sim <- sdiv.list[[1]]
sdiv.wait.sim <- sdiv.list[[3]]
sdiv.no.sim <- sdiv.list[[4]]
sdiv.one.sim <- sdiv.list[[5]]

# sdiv.wait.sim <- sdiv.list[[2]]
# sdiv.no.sim <- sdiv.list[[3]]
# sdiv.one.sim <- sdiv.list[[4]]
```


```{r}
# optional clean up
rm(sdiv.list,dr2list,dr1list,insure.list,sqlist)
```


### Prep to graph


Read in a variable key. This tells the `impact.table` function which variables to report results for, and in what order. There is a separate key for the supplementary diversification adaptation. 
```{r}
sqkey <- read_csv(here('data','sq_variable_key.csv'), col_names=TRUE)

sdiv.key <- read_csv(here('data','sdiv_variable_key.csv'), col_names=TRUE) %>%
  bind_rows(data.frame(variable="HAB",group="ecosystem"))
```


semi-qualitative categories, and color palette
```{r}
score.df <- data.frame(response=c("Negative-Strong","Negative-Weak","Equivocal","Positive-Strong","Positive-Weak","None"),response.num=c(-2,-1,0,2,1,NA))

table.palette.orange <- c("#04BC09", "#ABF1AD","grey85", "#dfc27d","#a6611a","black")
```


Sub-select variables to include in figures
```{r}
fig3_vars <- sqkey %>% 
# add a hab variable to the sqkey
  bind_rows(data.frame(variable="HAB",group="ecosystem")) %>%
  filter(group %in% c("well-being","well-being 2","well-being 3","capacity")) %>%
  filter(!(variable %in% c("Physical health","Physical safety","Entry of next generation","Equity in resource access")))
```


### Fig S8: All responses

```{r}
list3a <- list(sq.wait.sim,insure.wait.sim,dr1.wait.sim,dr2.wait.sim,sdiv.wait.sim)
names(list3a) <- c("Status Quo","Insurance","Direct Assistance Disaster Relief",
                   "Multi-Objective Disaster Relief","Supplementary Diversification")
plot3a <- compare.models.impact.tbl(list3a,
                                      perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = filter(sqkey, variable %in% fig3_vars), variable.order="specific_order_phd",
                                   plot=TRUE,main.axis="Y",table.palette = table.palette.orange, plot.perturbed=FALSE)
plot3a[[3]] + theme(legend.position="top") + guides(
  fill = guide_legend(order = 1,ncol=2,title.vjust=0.9, vjust=-5),
  shape = guide_legend(order = 0))
```



```{r}
list3b <- list(sq.no.sim,insure.no.sim,dr1.no.sim,dr2.no.sim,sdiv.no.sim)
names(list3b) <- c("Status Quo","Insurance","Direct Assistance Disaster Relief",
                   "Multi-Objective Disaster Relief","Supplementary Diversification")
plot3b <- compare.models.impact.tbl(list3b,
                                      perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = filter(sqkey, variable %in% fig3_vars), variable.order="specific_order",
                                   plot=TRUE,main.axis="Y",table.palette = table.palette.orange, plot.perturbed=FALSE)
plot3b[[3]]
```


```{r}
list3c <- list(sq.one.sim,insure.one.sim,dr1.one.sim,dr2.one.sim,sdiv.one.sim)
names(list3c) <- c("Status Quo","Insurance","Direct Assistance Disaster Relief",
                   "Multi-Objective Disaster Relief","Supplementary Diversification")
plot3c <- compare.models.impact.tbl(list3c,
                                      perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = filter(sqkey, variable %in% fig3_vars), variable.order="specific_order_phd",
                                   plot=TRUE,main.axis="Y",table.palette = table.palette.orange, plot.perturbed=FALSE)

plot3c[[3]]
```
**final plot**

```{r}
p1 <- plot3a[[3]] + 
  theme(legend.position="top",legend.title=element_text(size=8),legend.text=element_text(size=8),
        legend.margin=margin(t=0, r=0, b=-1.5, l=0, unit="cm"),
        plot.margin=margin(unit(c(5.5, 100.5, 5.5, 5.5), "points"))) +
  geom_vline(aes(xintercept=9.5), linewidth=0.5) +
  geom_vline(aes(xintercept=12.5), linewidth=0.5)+ guides(
    fill = guide_legend(order = 1,ncol=2,title.vjust=0.9, vjust=-5),
    shape = guide_legend(order = 0))

p2 <- plot3b[[3]] + 
  theme(legend.position="none", axis.text.x=element_blank(),
        plot.margin=margin(unit(c(-1.0, 100.5, 12.5, 6.5), "points"))) +
 geom_vline(aes(xintercept=9.5), linewidth=0.5) +
  geom_vline(aes(xintercept=12.5), linewidth=0.5) + guides(
    fill = guide_legend(order = 1,ncol=2,title.vjust=0.9, vjust=-5),
    shape = guide_legend(order = 0))

p3 <- plot3c[[3]] + scale_x_discrete(position = "bottom",expand = c(0.05, 0.05)) +
  theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1),
        plot.margin=margin(unit(c(9, 100.5, 5.5, 6), "points"))) +
  geom_vline(aes(xintercept=9.5), linewidth=0.5) +
  geom_vline(aes(xintercept=12.5), linewidth=0.5)+ guides(
    fill = guide_legend(order = 1,ncol=2,title.vjust=0.9, vjust=-5),
    shape = guide_legend(order = 0))
```
```{r}

png(here('doc','drafts','supplement','Fig3-absolute.png'),res=200,height=1820,width=1400)
plot_grid(plotlist=list(p1,p2,p3),nrow=3,rel_heights=c(1,0.43,0.9),rel_widths=c(1,0.05),
          labels=c("(a) Waiting for crab","(b) No Effect","(c) Switching targets",""),label_x=c(-0.1,-0.06,-0.115),label_y=c(0.42,1,1.05))
dev.off()

```


### Fig 3: Change from baseline

```{r}
list3a <- list(sq.wait.sim,insure.wait.sim,dr1.wait.sim,dr2.wait.sim,sdiv.wait.sim)
names(list3a) <- c("Status Quo","Insurance","Direct Assistance Disaster Relief",
                   "Multi-Objective Disaster Relief","Supplementary Diversification")
plot3a <- compare.baseline.impact.tbl(list3a,
                                      perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = fig3_vars, variable.order="specific_order",
                                   plot=TRUE,main.axis="Y",table.palette = table.palette.orange)

plot3a[[3]] + theme(legend.position="top") + guides(
  fill = guide_legend(order = 1,ncol=2,title.vjust=0.9, vjust=-5),
  shape = guide_legend(order = 0))
```



```{r}
list3b <- list(sq.no.sim,insure.no.sim,dr1.no.sim,dr2.no.sim,sdiv.no.sim)
names(list3b) <- c("Status Quo","Insurance","Direct Assistance Disaster Relief",
                   "Multi-Objective Disaster Relief","Supplementary Diversification")
plot3b <- compare.baseline.impact.tbl(list3b,
                                      perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key = fig3_vars, variable.order="specific_order",
                                   plot=TRUE,main.axis="Y",table.palette = table.palette.orange)
plot3b[[3]]
```


```{r}
list3c <- list(sq.one.sim,insure.one.sim,dr1.one.sim,dr2.one.sim,sdiv.one.sim)
names(list3c) <- c("Status Quo","Insurance","Direct Assistance Disaster Relief",
                   "Multi-Objective Disaster Relief","Supplementary Diversification")
plot3c <- compare.baseline.impact.tbl(list3c,
                                      perturb.list=list(c(`HAB`=1),
                                                           c(`HAB`=1,`insurance`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1),
                                                           c(`HAB`=1,`disaster relief (direct)`=1,`disaster relief (invest)`=1),
                                                           c(`HAB`=1)),
                                         monitor.list=list(NA,NA,NA,NA,NA),
                                    strong_lower=0.8, weak_lower=0.6, epsilon=1.0E-5,
                                    variable.key =fig3_vars, variable.order="specific_order",
                                   plot=TRUE,main.axis="Y",table.palette = table.palette.orange)

plot3c[[3]]
```

**final plot - panel 1 with legend**

```{r}

table.palette.legend <- c("#04BC09", "#ABF1AD","#a6611a","#dfc27d","grey85")


p1 <- plot3a[[3]] + 
  # write over legend to change order of colors
  scale_fill_discrete(name="Response",type=table.palette.legend, drop=FALSE, na.translate=FALSE, 
                      limits=c("Positive-Strong","Positive-Weak","Negative-Strong","Negative-Weak","Equivocal")) + 
  theme(legend.position="top",legend.title=element_text(size=8, face='bold'),legend.text=element_text(size=8),
        legend.margin=margin(t=0, r=0, b=-1.5, l=0, unit="cm"), legend.byrow = FALSE,
        plot.margin=margin(unit(c(5.5, 100.5, 5.5, 5.5), "points"))) +
  geom_vline(aes(xintercept=9.5), linewidth=0.5) +
  geom_vline(aes(xintercept=12.5), linewidth=0.5)+ guides(
    fill = guide_legend(order = 1,ncol=3,title.vjust=0.9, vjust=-5),
    shape = guide_legend(order = 0))
```



**final plot - panels 2 & 3**
```{r}
p2 <- plot3b[[3]] + 
  theme(legend.position="none", axis.text.x=element_blank(),
        plot.margin=margin(unit(c(-1.0, 100.5, 12.5, 6.5), "points"))) +
 geom_vline(aes(xintercept=9.5), linewidth=0.5) +
  geom_vline(aes(xintercept=12.5), linewidth=0.5)

p3 <- plot3c[[3]] + scale_x_discrete(position = "bottom",expand = c(0.05, 0.05)) +
  theme(legend.position="none",axis.text.x=element_text(angle=45,hjust=1),
        plot.margin=margin(unit(c(9, 100.5, 5.5, 6), "points"))) +
  geom_vline(aes(xintercept=9.5), linewidth=0.5) +
  geom_vline(aes(xintercept=12.5), linewidth=0.5)
```
```{r}

png(here('doc','drafts','Fig3-change-UPDATE.png'),res=200,height=1820,width=1400)
plot_grid(plotlist=list(p1,p2,p3),nrow=3,rel_heights=c(1,0.43,0.9),rel_widths=c(1,0.05),
          labels=c("(a) Waiting for crab","(b) No Effect","(c) Switching targets",""),label_x=c(-0.1,-0.06,-0.115),label_y=c(0.45,1,1.05))
dev.off()

```

